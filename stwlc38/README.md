# STWLC38 Driver

## Requirements

This driver requires the STWLC38 wireless charger chip. This is present on the `STEVAL-WLC38RX` board.


------

## Description

This driver provides API to update STWLC38 firmware and configurations. The driver is written in C programming language and developed based way below:
1.	Platform independent driver which users could easily integrate the driver without any modification needed. 
1.	Written in a way of clear and self-explainable sequences, as references to user if need to re-write the sequences in different code formatting.

The code documentation can be generated using the Doxygen tool.

------

## Hardware Setup
1. Connect a **5V** power supply to VRECT or VOUT
2. Connect the STWLC I2C pins to the master I2C bus.

------

## Source Code Integration
1. Include the driver files (.h and .c) and nvm_data.h which generated by [STSW-WPSTUDIO GUI](https://www.st.com/en/embedded-software/stsw-wpstudio.html).

2. Define platform functions and variables to be used by driver API. See below for the function definitions.

```
    int32_t platform_write(void *phandle, uint8_t *wbuf, int32_t wlen);
    int32_t platform_write_read(void *phandle, uint8_t *wbuf, int32_t wlen, uint8_t *rbuf, int32_t rlen);
    void platform_delay(uint32_t millisec);
    void *platform_alloc_mem(size_t size);
    void platform_free_mem(void *ptr);
```

3. Declare and initialize driver interfaces
- To use this driver, users need to declare and assign the platform functions to mandatory interfaces.

```
    /** stwlcxx is the used part number **/ 
    struct stwlcxx_dev stwlc38 = { 0 };

    stwlc38.bus_write = platform_write;
    stwlc38.bus_write_read = platform_write_read;
    stwlc38.mdelay = platform_delay;
    stwlc38.alloc_mem = platform_alloc_mem;
    stwlc38.free_mem = platform_free_mem;
```

- If user data is needed by the platform functions, initialize the phandle parameter.

```
    struct stmdev_platform platform = {
            .hi2c = &hi2c1,
            .huart = &huart3,
    };
    stwlc38.phandle = &platform;
```

- Optionally, users can print the log messages by initializing log parameters and set log_info to 1 to print more information logs.

```
    stwlc38.log = platform_log;
    stwlc38.log_info = 1;
```

------
## Appendix

### Example Code using STM32 MCU
#### main.c

```
static uint8_t i2cSequentialRxDone = 0;
static uint8_t i2cSequentialTxDone = 0;

void HAL_I2C_MasterTxCpltCallback(I2C_HandleTypeDef *hi2c)
{
	i2cSequentialTxDone = 1;
}

void HAL_I2C_MasterRxCpltCallback(I2C_HandleTypeDef *hi2c)
{
	i2cSequentialRxDone = 1;
}

int32_t platform_write(void *phandle, uint8_t *wbuf, int32_t wlen)
{
	struct stmdev_platform *platform = (struct stmdev_platform *)phandle;
	HAL_StatusTypeDef status = HAL_OK;
	uint32_t startTick;

	i2cSequentialTxDone = 0;
	startTick = HAL_GetTick();

	status = HAL_I2C_Master_Seq_Transmit_IT(platform->hi2c, _I2C_ADDR << 1, wbuf, wlen, I2C_FIRST_AND_LAST_FRAME);
	if(status != HAL_OK)
		return status;

	while(i2cSequentialTxDone == 0)
	{
		if((HAL_GetTick() - startTick) > IO_DELAY_MS)
		{
			return HAL_TIMEOUT;
		}
	}

	return 0;
}

int32_t platform_write_read(void *phandle, uint8_t *wbuf, int32_t wlen, uint8_t *rbuf, int32_t rlen)
{
	struct stmdev_platform *platform = (struct stmdev_platform *)phandle;
	HAL_StatusTypeDef status = HAL_OK;
	uint32_t startTick;

	i2cSequentialTxDone = 0;
	i2cSequentialRxDone = 0;
	startTick = HAL_GetTick();

	status = HAL_I2C_Master_Seq_Transmit_IT(platform->hi2c, STWLC38_I2C_ADDR << 1, wbuf, wlen, I2C_FIRST_FRAME);
	if(status != HAL_OK)
		return status;

	while(i2cSequentialTxDone == 0)
	{
		if((HAL_GetTick() - startTick) > IO_DELAY_MS)
		{
			return HAL_TIMEOUT;
		}
	}

	status = HAL_I2C_Master_Seq_Receive_IT(platform->hi2c, STWLC38_I2C_ADDR << 1, rbuf, rlen, I2C_LAST_FRAME);
	if(status != HAL_OK)
		return status;

	while(i2cSequentialRxDone == 0)
	{
		if((HAL_GetTick() - startTick) > IO_DELAY_MS)
			return HAL_TIMEOUT;
	}

	return 0;
}

void platform_delay(uint32_t millisec)
{
    HAL_Delay(millisec);
}

void *platform_alloc_mem(size_t size)
{
    return malloc(size);
}

void platform_free_mem(void *ptr)
{
    free(ptr);
}

```
### Example I2C Error Handling using STM32 MCU
#### stm32xxxx_it.c
```
/**
  * @brief This function handles I2C1 Error interrupt.
  */
void I2C1_ER_IRQHandler(void)
{
  /* USER CODE BEGIN I2C1_ER_IRQn 0 */
  /* Comment out the HAL_I2C_ER_IRQHandler() as I2C NACK workaround
   * during reset STWLC38 */

  /* USER CODE END I2C1_ER_IRQn 0 */
  //HAL_I2C_ER_IRQHandler(&hi2c1);
  /* USER CODE BEGIN I2C1_ER_IRQn 1 */

  /* USER CODE END I2C1_ER_IRQn 1 */
}
```
------

**More Information: [ST wireless charger ICs](https://www.st.com/en/power-management/wireless-charger-ics)**

**Copyright (C) 2023 STMicroelectronics**