# STWBC86 Driver

## Requirements

This driver requires the STWBC86 wireless charger chip. This is present on the `STEVAL-WBC86TX` board.


------

## Description

This driver provides API to update STWBC86 firmware and configurations. The driver is written in C programming language and developed based way below:
1.    Platform independent driver which users could easily integrate the driver without any modification needed.
1.    Written in a way of clear and self-explainable sequences, as references to user if need to re-write the sequences in different code formatting.

The code documentation can be generated using the Doxygen tool.


------

## Hardware Setup
1. Connect a **5V** power supply to VRECT or VOUT
2. Connect the STWLC I2C pins to the master I2C bus.

------

## Source Code Integration
1. Include the driver files (.h and .c) and nvm_data.h which generated by [STSW-WPSTUDIO GUI](https://www.st.com/en/embedded-software/stsw-wpstudio.html).

2. Define platform functions and variables to be used by driver API. See below for the function definitions.

```
    int32_t platform_write(void *phandle, uint8_t *wbuf, int32_t wlen);
    int32_t platform_write_read(void *phandle, uint8_t *wbuf, int32_t wlen, uint8_t *rbuf, int32_t rlen);
    void platform_delay(uint32_t millisec);
    void *platform_alloc_mem(size_t size);
    void platform_free_mem(void *ptr);
```

3. Declare and initialize driver interfaces
- To use this driver, users need to declare and assign the platform functions to mandatory interfaces.

```
    /** stwbc86 is the used part number **/
    struct stwbc86_dev stwbc86 = { 0 };

    stwbc86.bus_write = platform_write;
    stwbc86.bus_write_read = platform_write_read;
    stwbc86.mdelay = platform_delay;
    stwbc86.alloc_mem = platform_alloc_mem;
    stwbc86.free_mem = platform_free_mem;
```

- If user data is needed by the platform functions, initialize the phandle parameter.

```
    struct stmdev_platform {
        I2C_HandleTypeDef *hi2c;
        UART_HandleTypeDef *huart;
    };

    struct stmdev_platform platform = {
        .hi2c = &hi2c1,
        .huart = &huart3,
    };
    stwbc86.phandle = &platform;
```

- Optionally, users can print the log messages by initializing log parameters and set log_info to 1 to print more information logs.

```
    stwbc86.log = platform_log;
    stwbc86.log_info = 1;
```

------

## FAQ

1. There is an I2C transaction NACK error that happened when writing system reset command to STWBC86.

    This is a known issue and its limitation of STWBC86. 
    Host shall ignore this error and proceed with the following I2C transactions. Users may implement conditional error handling. 


------

## Appendix

### Example Code using STM32 MCU

#### main.c

```
static uint8_t i2cSequentialRxDone = 0;
static uint8_t i2cSequentialTxDone = 0;

void HAL_I2C_MasterTxCpltCallback(I2C_HandleTypeDef *hi2c)
{
    i2cSequentialTxDone = 1;
}

void HAL_I2C_MasterRxCpltCallback(I2C_HandleTypeDef *hi2c)
{
    i2cSequentialRxDone = 1;
}

int32_t platform_write(void *phandle, uint8_t *wbuf, int32_t wlen)
{
    struct stmdev_platform *platform = (struct stmdev_platform *)phandle;
    HAL_StatusTypeDef status = HAL_OK;
    uint32_t startTick;

    i2cSequentialTxDone = 0;
    startTick = HAL_GetTick();

    status = HAL_I2C_Master_Seq_Transmit_IT(platform->hi2c, STWBC86_I2C_ADDR << 1, wbuf, wlen, I2C_FIRST_AND_LAST_FRAME);
    if(status != HAL_OK)
        return status;

    while(i2cSequentialTxDone == 0)
    {
        if((HAL_GetTick() - startTick) > 1000)
        {
            /* I2C NACK WORKAROUND */
            /* Process Unlocked */
            __HAL_LOCK(platform->hi2c);

            /* Clear STOP Flag */
            __HAL_I2C_CLEAR_FLAG(platform->hi2c, I2C_FLAG_STOPF);

            /* Clear Configuration Register 2 */
            I2C_RESET_CR2(platform->hi2c);

            platform->hi2c->State = HAL_I2C_STATE_READY;
            platform->hi2c->Mode  = HAL_I2C_MODE_NONE;

            /* Process Unlocked */
            __HAL_UNLOCK(platform->hi2c);

            return 0;
        }
    }

    return 0;
}

int32_t platform_write_read(void *phandle, uint8_t *wbuf, int32_t wlen, uint8_t *rbuf, int32_t rlen)
{
    struct stmdev_platform *platform = (struct stmdev_platform *)phandle;
    HAL_StatusTypeDef status = HAL_OK;
    uint32_t startTick;

    i2cSequentialTxDone = 0;
    i2cSequentialRxDone = 0;
    startTick = HAL_GetTick();

    status = HAL_I2C_Master_Seq_Transmit_IT(platform->hi2c, STWBC86_I2C_ADDR << 1, wbuf, wlen, I2C_FIRST_FRAME);
    if(status != HAL_OK)
        return status;

    while(i2cSequentialTxDone == 0)
    {
        if((HAL_GetTick() - startTick) > 1000)
        {
            return HAL_TIMEOUT;
        }
    }

    status = HAL_I2C_Master_Seq_Receive_IT(platform->hi2c, STWBC86_I2C_ADDR << 1, rbuf, rlen, I2C_LAST_FRAME);
    if(status != HAL_OK)
        return status;

    while(i2cSequentialRxDone == 0)
    {
        if((HAL_GetTick() - startTick) > 1000)
            return HAL_TIMEOUT;
    }

    return 0;
}

void platform_delay(uint32_t millisec)
{
    HAL_Delay(millisec);
}

void *platform_alloc_mem(size_t size)
{
    return malloc(size);
}

void platform_free_mem(void *ptr)
{
    free(ptr);
}

```

------

**More Information: [ST wireless charger ICs](https://www.st.com/en/power-management/wireless-charger-ics)**

**Copyright (C) 2023 STMicroelectronics**